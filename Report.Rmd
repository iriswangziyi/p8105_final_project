---
title: "Beer Taxation Report in US"
author: 'Author: Amy Pitts (ajp2257), Ruiyang Li (rl3034), Wenbo Fei (wf2270), Ziyi Wang (zw2716)'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(rvest)
library(httr)
```

### To learn our project:
* A short [review](put screencast link here) of our project
* Explore more on our [website](https://iriswangziyi.github.io/p8105_final_project) 
* Find our Github [repository ](https://github.com/iriswangziyi/p8105_final_project)

### Motivation:
Statistics have been intertwined with beer since the 20th century. During his time at Guinness Brewing Company of Dublin, Ireland mathematician Gosset published a paper in 1904 about using a Poisson distribution to model the amount of yeast cells in the Beer fermentation process (The Lady Tasting Tea). This helped lead to a much more accurate assessment of the concentration of yeast cells in the beer mash and thus a much more consistent product was produced by Guinness. However, due to not wanting to leak company secrets Guinness did not let Gosset publish in appropriate papers, this led him to publish his work under the name “Student” while he worked under Pearson (The Lady Tasting Tea). 

Beer has been around for centuries. When the Mayflower set sail from America they loaded up on all the essentials including lots of beer and when they ran out they decided to stop as soon as possible landing them on Plymouth rock. “We could not now take time for further search… our victuals being much spent, especially our beer…” [Beer & American History](https://www.beerinstitute.org/news-media/additional-beer-resources/beer-american-history/ ). To their surprise, the Native Americans had been brewing beer from maize way before they invaded their land. After that point brewers have been popping up all over the United States. Beer had become so important in the establishment of the American nation that “George Washington’s first acts as Commander of the Continental Army was to proclaim that every one of his troops would receive a quart of beer with his daily rations” [Beer & American History](https://www.beerinstitute.org/news-media/additional-beer-resources/beer-american-history/ ). 

Fast forward to after the prohibition the American Government continues to control the consumption and production of Beer through regulations and taxes. The Alcohol and Tobacco Tax and Trade Bureau protects “the public by enforcing the provisions of the Federal Alcohol Administration Act” [TTB.gov](https://www.ttb.gov/alcohol/beverage-alcohol). This helps regulate people who engage in the alcohol beverage industry by requiring people to file an application before engaging in business. For Breweries in particular they are required to file the yearly Brewer’s Report of Operations (TTB F 5130.9) and the Quarterly Brewer’s Report of Operations (TTB F 5130.26) [TTB.gov Statistics]( https://www.ttb.gov/beer/statistics). The Breweries must report this information no later than 15 days after the close of the applicable reporting period [TTB.gov Statistics]( https://www.ttb.gov/beer/statistics). Through this reporting and taxation, the U.S. profits enormously off of this one beverage. From a report, it is estimated that the American beer industry contributes to “more than $328 billion to our economy” [Beer Institute](https://www.beerinstitute.org/beer-policy/overview/). The jobs it creates are in a wide range of areas such as farming, manufacturing, construction, transportation, service, and more. Since beer plays such an important role in the U.S. economy it is important to analyze the publicly available government data all about taxation and production [TTB.gov](https://www.ttb.gov/alcohol/beverage-alcohol). It is also equally interesting to look at the types of beer produced, location of breweries across the globe using an open-source API data set [Open Beer Dataset](https://data.opendatasoft.com/explore/dataset/open-beer-database%40public-us/table/). Our goal in this project is to get a better understanding of the taxation, consumption and production of beer by each state to get a better understanding of how the United States profits off beer. 


### Related work: 
There has been a lot of research into overall how the United States economy is profiting off of beer. Below is a list of related work done on summarizing taxation of beer and how it plays a role in our economy. 

- The first taxation summary report that sparked our interest was done by [KPMG](https://www.nbwa.org/sites/default/files/NBWA_Report_2009.pdf). This report described the history of taxation of beer and how it has changed over time. It also explained the profit gathered, jobs created and product produced. In depth description of the specific types of taxes are also described. 
- The [American’s Beer Distributor](https://www.nbwa.org/government/state-policy-issues) has a great compilation of all types of laws that affect how beer is taxed. This summary gives a great overview at all the moving parts of taxation as well as additional sources to learn more. This source was also where we got more data.
- One type of taxation is [Beer franchise law](https://www.nbwa.org/government/benefits-of-beer-franchise-laws). These laws help local brewers can be competitive in the marketplace. Although there are a lot of nuances behind these laws they are in place to help consumers be able to have lots of choices and breweries have access to ways to promote themselves.  This inpacks our analysis because through all the different ways breweries are tax really influence the tax rate of the beer and the cumulative tax growth per year. 
- Another great documentation of state taxation laws is collected on the [NCSLA webpage](https://www.ncsla.org/State-Officials.html). This webpage split the states up into two type of taxation laws, License Jurisdiction and Control Jurisdiction. There two different types of government power influence how breweries operate and how taxation happens. This webpage and further description on each state inspired our Analysis page. Please go to that page to read more about our search to see if these two types of Jurisdictions influence taxation between states. 
- The [Alcohol Law Review](https://www.alcohollawreview.com/category/alcohol-regulation/)  has an up to date complication of all the new laws that are being passed about alcohol. This can be anything from taxation to how alcohol can be shipped to consumption laws. It is also a historial bank of all alcohol related laws. 


### Initial questions: 
* How much profit and product does each state in the US make each year?
* How does the tax rate change over time per state? Which state gives more beer tax? Any trends?
* What category/brewer/style of beer has the most Alcohol by volume (ABV)?
* Map location of each US brewer with interactive label showing category/style, size of marker showing ABV.

What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?
Discuss this in the meeting.

* What is the cumulative/average taxation over time in each state?
* What is the beer consumption per capita over time in each state?
* Where are all the US breweries located?
* What is the average alcohol by volume (ABV) in each state?
* What is the common beer style in each state?
* What is the top 8 beer style?
* What is the number of barrels/cans and bottles of beer produced by each state?
* What is the amount of shipments made of malt beverages?
* Is there a difference in tax/cumulative tax/tax per barrel between the two jurisdiction groups?
* Is there a linear relationship between taxation and jurisdiction group, year, shipments, population, and consumption?

 
### Data: source, scraping method, cleaning
* Dataset 1

Yearly Statistical Beer Data by State (2008 – 2019) from [Alcohol and Tobacco Tax and Trade Bureau](https://www.ttb.gov/beer/statistics). This aggregated data contained records on Tax Determined, Taxable Volume of Bottles and Cans, Taxable Volume of Barrels and Kegs each year for each state in barrels.
```{r data1, warning=FALSE, message=F, cache=TRUE}
#install.packages("gdata")
site1 = "http://www.ttb.gov/images/pdfs/statistics/aggregated/aggr-data-beer_2008-2019.xlsx"

#Tax Determined (in Barrels)
tax_df  =  
  gdata::read.xls(site1, sheet = 1, header = T, skip = 6, nrow = 52) %>% #skip note
  janitor::clean_names() %>%
  select(1:13) %>%
  as_tibble() %>%
  rename_with( ~ sub("x", "", .x)) %>% # rename column names
  mutate(state = factor(state)) %>% #state as factor
  mutate_at(vars(2:13), ~ gsub(",", "", .x)) %>% #remove "," in tax values
  mutate_at(vars(2:13), as.numeric) # tax values as numeric

# Taxable Volume of Bottles and Cans* (in Barrels)
taxable_cans_df  = 
  gdata::read.xls(site1, sheet = 2, header = T, skip = 4, nrow = 52) %>% 
  janitor::clean_names() %>%
  select(1:13) %>%
  as_tibble() %>%
  rename_with( ~ sub("x", "", .x)) %>%
  mutate(state = factor(state)) %>%
  mutate_at(vars(2:13), ~ gsub(",", "", .x)) %>%
  mutate_at(vars(2:13), as.numeric)

# Taxable Volume of Barrels and Kegs*
taxable_barrels_df  = 
  gdata::read.xls(site1, sheet = 3, header = T, skip = 4, nrow = 52) %>% 
  janitor::clean_names() %>%
  select(1:13) %>%
  as_tibble() %>%
  rename_with( ~ sub("x", "", .x)) %>%
  mutate(state = factor(state)) %>%
  mutate_at(vars(2:13), ~ gsub(",", "", .x)) %>%
  mutate_at(vars(2:13), as.numeric)

head(tax_df)
head(taxable_cans_df)
head(taxable_barrels_df)
# write_csv(tax_df, "data_import_cleaning/tax.csv")
# write_csv(taxable_cans_df, "data_import_cleaning/tax_cans.csv")
# write_csv(taxable_barrels_df, "data_import_cleaning/tax_barrels_df.csv")
```


* Dataset 2

Open Beer database from [Opendatasoft](https://data.opendatasoft.com/explore/dataset/open-beer-database%40public-us/information/?rows=4588&timezone=&refine.country=United+States&location=2,16.98232,9.498&basemap=jawg.sunny&dataChart=eyJxdWVyaWVzIjpbeyJjb25maWciOnsiZGF0YXNldCI6Im9wZW4tYmVlci1kYXRhYmFzZUBwdWJsaWMtdXMiLCJvcHRpb25zIjp7fX0sImNoYXJ0cyI6W3siYWxpZ25Nb250aCI6dHJ1ZSwidHlwZSI6ImxpbmUiLCJmdW5jIjoiQVZHIiwieUF4aXMiOiJhYnYiLCJzY2llbnRpZmljRGlzcGxheSI6dHJ1ZSwiY29sb3IiOiIjMTQyRTdCIn1dLCJ4QXhpcyI6Imxhc3RfbW9kIiwibWF4cG9pbnRzIjoiIiwidGltZXNjYWxlIjoieWVhciIsInNvcnQiOiIifV0sImRpc3BsYXlMZWdlbmQiOnRydWUsImFsaWduTW9udGgiOnRydWV9). This dataset contains information of each beer product, including product name, universal product code, style, category, brewer along with its address and website, percentage of alcohol by volume, bitterness from hops in a beer, beer color, and description in text.

```{r read2, warning=FALSE, message=F, cache=TRUE}
beer_specific = 
  read_delim("https://public-us.opendatasoft.com/explore/dataset/open-beer-database/download/?format=csv&timezone=America/New_York&lang=en&use_labels_for_header=true&csv_separator=%3B", delim = ";") %>% # sep = ";"
  janitor::clean_names() %>%
  filter(country == "United States") %>% # only investigate beer in US
  separate(coordinates, c("latitude", "longitude"), sep = ",") # separate geographic info

head(beer_specific)
# write_csv(beer_specific, "data_import_cleaning/beer.csv")
```

* Dataset 3 -- Amy?
Amy, please add your data source, scraping method and cleaning, code and comment.

### Exploratory analysis: 
Visualizations, summaries, and exploratory statistical analyses. Justify the steps you took, and show any major changes to your ideas.
Each of us add our part, should include code that can generate the plot(please note file path), comment on the plots and answer the above corresponding initial questions part.
I will try to revise them in a reasonable order.

#### Amy:

#### Ruiyang:

**Alcohol by volume (ABV)** is defined to be the volume percent of alcohol (ethanol) contained in a given volume of an alcoholic beverage. In our project, we are interested in exploring the pattern of ABV concerning the category/brewer/style of beer (initial question 3). 

**By category**

First, we looked at the pattern of ABV by beer's category. 

* Based on our dataset, **Belgian and French Ale** has the **highest** average ABV while the **North American Lager** has the **lowest** average ABV. 

```{r cat_abv,collapse=TRUE,message=FALSE,warning=FALSE}
beer = read_csv("./data_import_cleaning/beer.csv")

cat_abv = 
  beer %>% 
  replace_na(list(category = "NA", y = "unknown")) %>% 
  group_by(category) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv)) 
cat_abv
cat_abv %>% 
  mutate(category = fct_reorder(category, mean_abv)) %>% 
  plot_ly(x = ~category, y = ~mean_abv, 
          color = ~category, type = "bar", colors = "viridis") %>% 
  layout(title = "Average ABV by Beer Category",
         xaxis = list(title = "Beer Category",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(0, 7)))
```

**By brewer**

Next, we looked at the pattern of ABV by beer's brewer. 

As there are 823 brewers listed in our dataset, we will show the **top 20** that has the highest average ABV, rather than all of them. 

* **Mendocino Brewing - Ukiah** has the highest average ABV. 
* There are 424 brewers having average ABV value of 0. 

```{r brewer_abv,collapse=TRUE,message=FALSE,warning=FALSE}
brewer_abv = 
  beer %>% 
  group_by(brewer) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv))
brewer_abv

#brewer_abv %>% filter(mean_abv == 0) #424

brewer_abv %>% 
  slice(1:20) %>% 
  mutate(brewer = fct_reorder(brewer, mean_abv)) %>%
  plot_ly(x = ~brewer, y = ~mean_abv, 
          color = ~brewer, type = "bar", colors = "viridis") %>%
  layout(title = "Average ABV by Beer Brewer",
         xaxis = list(title = "Beer Brewer",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(8, 10.8)))
```

**By style**

Finally, we looked at the pattern of ABV by beer's style. 

There are 62 styles listed in our dataset, and we will show the **top 20** that has the highest average ABV, as well as the **lowest 5**. 

* We can see that **Belgian-Style Quadrupel** has the higherst average ABV while both **Vienna-Style Lager** and **Specialty Honey Lager or Ale** has average ABV of 0. 

```{r style_abv,collapse=TRUE,message=FALSE,warning=FALSE}
style_abv = 
  beer %>% 
  group_by(style) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv))
style_abv

style_abv %>% 
  slice(1:20) %>% 
  mutate(style = fct_reorder(style, mean_abv)) %>% 
  plot_ly(x = ~style, y = ~mean_abv, 
          color = ~style, type = "bar", colors = "viridis")  %>%
  layout(title = "Average ABV by Beer Style",
         xaxis = list(title = "Beer Style",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(5.5, 12)))

tail(style_abv) %>% 
  rename(Style = style, `Average ABV` = mean_abv) %>% 
  slice(-1) %>% 
  mutate_at(2, round, 2) %>% 
  knitr::kable(caption = "Styles with Lowest 5 Average AVB") %>% 
  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
                            full_width = F)
```




#### Wenbo:

#### Iris:


### Regression Analysis: -- Ruiyang?
If you undertake formal statistical analyses, describe these in detail

[starts here]

We focus on two analyses in our project. One is to compare tax differences by jurisdiction group over time. The other is to model taxation under the regression analysis framework. More details can be found in the Analysis section on our website (link to be inserted here). 

**1. Preliminary Analysis** -- Tax differences by jurisdiction group

**Motivation**

Differing on the degree of control on liquor wholesales and retail, states can be categorized into two [types](https://www.ncsla.org/State-Officials.html) -- control jurisdiction and licensed jurisdiction, with licensed states having more control. Such categorization may lead to difference in taxation. Therefore, we are interested in examining if there is any difference in taxation by these two groups of states. 

**Procedures**

We performed t-test for each year from 2010 to 2019 and would like to see if there is any significant difference in the cumulative tax between control states and licensed states. 

**Findings**

Based on the test results, however, we did not find sufficient evidence showing any significant difference between two jurisdiction groups in both the cumulative tax collected and the tax per barrel from 2010 to 2019. 

We speculated that there may be some confounding variables that could potentially affect the relationship between taxation and the jurisdiction group. Therefore, we decided to further perform regression analysis. Specifically, we would like to explore more regarding the relationship between taxation and jurisdiction group, year, shipments, population, and consumption.

**2. Regression Analysis**

**Variables of interest**

Our explaining variables of interest include jurisdiction group, year, shipments, population, and consumption. Their detailed explanation are as below.

* group: jurisdiction group (control vs licensed)
* shipments: amount of barrels shipped
* population: the number of individuals who are 21 years old or older
* consumption: consumption of barrels per capital

**Model**

Our intended model is 

$$Tax = \beta_0 + \beta_1 \ Group + \beta_2 Year + \beta_3 \ Shipments + \beta_4 \ Population+ \beta_5 \ Consumption$$

We looked at both the cumulative tax collected and the tax per barrel. 

**Results & Findings**

In the model of the **tax per barrel**, all the variables are **not significant** at the 5% significance level; further the model is poorly fitted as the adjusted $R^2$ is approximately 0. Therefore, we will mostly focus on the cumulative tax collected. 

In the model of **cumulative tax collected**, we found that: 

* All variables in our model are **significant** at the 5% significance level. 
* Our model fit is acceptable with an adjusted $R^2 = 0.55$. 
* Previously, we did not find any significant difference in the cumulative tax between two jurisdiction groups. However, after controlling for year, shipments, population and consumption, we found that **licensed states** are estimated to have approximately **7.5k less cumulative tax collected** than the control states.
* **Cumulative tax collected** is estimate to **increase approximately 7k per year**, holding the group, shipments, population and consumption unchanged. 
* Cumulative tax collected is estimated to **increase approximately 1k for one unit increase in consumption per capital**, holding the group, year, shipments, and population unchanged. 
* Population and shipments have estimated coefficients close to 0, though they have significant p-values. 

```{r reg_df,collapse=T,message=FALSE,warning=FALSE}
# Load datasets
state_df = read_csv("data_import_cleaning/state_df.csv")
tax_df = read_csv( "data_import_cleaning/tax.csv")

# state and its abbreviation
# https://abbreviations.yourdictionary.com/articles/state-abbrev.html
state_ref = 
  read.delim("./data_import_cleaning/state_abbreviation.txt", header = F) %>%
  separate(V1, into = c("state", "state_abbrv"), sep = " - ") 

# jurisdiction information
license = 
  read_table("./data_import_cleaning/license_jurisdiction_modified.txt") %>%
  unlist()
control = 
  read_table("./data_import_cleaning/control_jurisdiction_modified.txt") %>%
  unlist()

# tidy tax data: state with abbreviation + group
# to be consistent with other plots, remove year 2008, 2009 (starting year is 2010)
tax_df_group =  
  left_join(tax_df %>% rename(state_abbrv = state), 
            state_ref, by = "state_abbrv") %>% 
  mutate(
    group = ifelse(state %in% license, "licensed", 
                   ifelse(state %in% control, "control", "NA"))
  ) %>% 
  relocate(state_abbrv, state, group) %>% 
  slice(-52) %>% 
  select(-`2008`, -`2009`)

# Merge dataset: tax_df_group + state_df
reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2010":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption)

# Replace 0's with NA's
reg_df[reg_df == 0] <- NA

# Fit model
lm_model = lm(total_tax ~ group + year + shipments + population + consumption, data = reg_df)
summary(lm_model)

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  rename(
    Variable = term,
    Coefficient = estimate, 
    `Standard Error` = std_error,
    `t-Statistic` = statistic, 
    `P-value` = p_value
  ) %>% 
  mutate(
    Variable = ifelse(Variable == "grouplicensed", "Licensed Group", Variable), 
    Variable = str_to_title(Variable)
  ) %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 10)) %>% 
  DT::formatStyle(
    columns = "P-value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```


[ends here]



### Discussion: 
What were your findings? Are they what you expect? What insights into the data can you make?

Discuss in the meeting.

