---
title: "tax_data_vis"
author: "Amy Pitts"
date: "11/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(flexdashboard)
```

### get the data! 
```{r, warning=FALSE, message=FALSE}
tax_df         = read_csv( "data_import_cleaning/tax.csv")
tax_cans_df    = read_csv("data_import_cleaning/tax_cans.csv")
tax_barrels_df = read_csv("data_import_cleaning/tax_barrels_df.csv")
```

### Looking at just the taxes collected by state 
"Beer removed for consumption or sale including beer removed tax determined for consumption or sale in a tavern or on brewery premises"

```{r}
tax_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "tax"
  ) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~tax, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Tax collected over the years by state")
```

### looking at the amount Barrels produced by state recorded in barrel units 

```{r}
tax_barrels_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "barrels"
  ) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~barrels, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Barrel production over the years by state")
```

### looking at the amount of cans and bottles produced by state over years recorded in barel units 

```{r}
tax_cans_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "cans_bottles"
  ) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~cans_bottles, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Can and Bottleproduction over the years by state")
```

### Trying to find the tax rate per state 
to find the tax rate I cam going to add up the barrel and can and bottle production then use this to divide by the tax collected 
# This does not make sense!
```{r}
state = tax_df %>% select(state) 
tax_rate_df =  tax_df %>% select(-state) /
  (tax_barrels_df %>% select(-state)  + 
   tax_cans_df %>%select(-state) ) 

tibble(state, tax_rate_df) %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "tax_rate"
  ) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~tax_rate, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Tax rate over the years by state")
```

Instead we should use the tax rate per barrel found in the pdf document and then multiply this by the amount of barrel and cans and bottle produced by each state. this gives us the overall tax collected. then we should compare this to the first plot above and this will help us answer the question about how much tax is collected from people buying from brewerys directly vs how much tax was collected overall. it would be interesting to see if these datasources match up. 



Here is me trying the animation 
```{r}
# here is all the libraries they used 
library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)
```

```{r}
# knitr::opts_chunk$set(
#  echo = FALSE,
#  fig.width = 7, 
#  fig.height = 5,
#  fig.asp = 0.6,
#  out.width = "70%")
# theme_set(theme_bw() + 
#           theme(legend.position = "bottom",
#                 legend.title = element_blank(),
#                 plot.title = element_text(hjust = 0.5, size = 15),
#                 plot.subtitle = element_text(hjust = 0.5, size = 12)))
# 
# long_tax_df<-maindata %>% select(state,year,sex,suicides_no)
# n<-unique(tax_df$state)
# state<-function(x){
#   suicide2<-long_tax_df %>% filter(state==x)
#   sum(suicide2$suicides_no)
# }
# state_total<-sapply(n,function(x) state(x))
# top_state<- long_tax_df %>% filter(state %in% c(
#   "Russian Federation",
#   "United States",
#   "Japan",
#   "France",
#   "Ukraine",
#   "Germany",
#   "Republic of Korea",
#   "Brazil",
#   "Poland",
#   "United Kingdom",
#   "Italy",
#   "Mexico",
#   "Canada",
#   "Thailand",
#   "Kazakhstan",
#   "Spain"))
# top_state$sex<-as.factor(top_state$sex)
# sm3<-aggregate(suicides_no~state+year,top_state,sum) %>% 
#   group_by(year) %>% 
#   mutate(rank = min_rank(-suicides_no)) %>%
#   ungroup()
# static_plot<-ggplot(sm3,aes(rank,group=state,fill=as.factor(state),color=as.factor(state))) +
#  geom_tile(aes(y = suicides_no/2,height = suicides_no, width = 0.9), alpha = 0.8, color = NA) +
#  geom_text(aes(y = 0, label = paste(state, ' ')), vjust = 0.2, hjust = 1) +
#  geom_text(aes(y=suicides_no,label = paste(' ',suicides_no)), hjust=0)+
#  coord_flip(clip = 'off', expand = TRUE) +
#  scale_y_continuous(labels = scales::comma) +
#  scale_x_reverse() +
#  guides(color = FALSE, fill = FALSE) +
#  theme_minimal() +
#  theme(
#  plot.title=element_text(size=25, hjust=0.5, face='bold', colour='grey', vjust=-1),
#  plot.subtitle=element_text(size=18, hjust=0.5, face='italic', color='grey'),
#  plot.caption =element_text(size=8, hjust=0.5, face='italic', color='grey'),
#  axis.ticks.y = element_blank(), 
#  axis.text.y = element_blank(), 
#  plot.margin = margin(1,1,1,4, 'cm')
#  )
# plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) + 
#  ease_aes('cubic-in-out') +
#  labs(title = 'Total Suicides per Year : {closest_state}', 
#  x='',y='Total Suicides per year')
# final_animation<-animate(plt,100,fps = 20,duration = 30, width = 950, height = 750, renderer = gifski_renderer())
# final_animation
```

```{r}
long_tax_df = tax_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "tax"
  ) 

top_state <- long_tax_df %>% filter(state %in% c(
"CA",				
"NC",				
"TX",				
"FL",				
"CO",				
"VA",				
"NY",				
"WA",				
"OH",				
"MI",
"OR",				
"IL",				
"MN",				
"PA",				
"MA",				
"NJ",				
"WI",				
"IA",				
"TN",				
"IN"
))



# aggregate(tax~state+year,top_state,tax) %>%
#   group_by(year) %>%
#   mutate(rank = min_rank(-tax)) %>%
#   ungroup()
```




