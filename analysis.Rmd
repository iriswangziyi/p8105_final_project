---
title: "Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

```{r df_tidy, collapse=TRUE,message=FALSE, include=FALSE}
tax_df = read_csv( "data_import_cleaning/tax.csv")
state_tax_df = read_csv("data_import_cleaning/state_tax_df.csv")

# https://abbreviations.yourdictionary.com/articles/state-abbrev.html
state_ref = 
  read.delim("./data_import_cleaning/state_abbreviation.txt", header = F) %>%
  separate(V1, into = c("state", "state_abbrv"), sep = " - ") 

# jurisdiction informatiomn
license = 
  read_table("./data_import_cleaning/license_jurisdiction_modified.txt") %>%
  unlist()
control = 
  read_table("./data_import_cleaning/control_jurisdiction_modified.txt") %>%
  unlist()

# tidy tax data: state with abbreviation + group
tax_df_group =  
  left_join(tax_df %>% rename(state_abbrv = state), 
            state_ref, by = "state_abbrv") %>% 
  mutate(
    group = ifelse(state %in% license, "licensed", 
                   ifelse(state %in% control, "control", "NA"))
  ) %>% 
  relocate(state_abbrv, state, group) %>% 
  slice(-52)

state_tax_df_group = 
  left_join(state_tax_df, state_ref, by = "state") %>% 
  mutate(
    group = ifelse(state %in% license, "licensed", 
                   ifelse(state %in% control, "control", "NA"))
  ) %>% 
  relocate(state_abbrv, state, group)
```

We focus on two analyses in this section. One is to compare tax differences by jurisdiction group over time. The other is to model taxation under the regression analysis framework. 

---

# Tax differences by jurisdiction group

Differing on the degree of control on liquor wholesales and retail, states can be categorized into two [types](https://www.ncsla.org/State-Officials.html) -- control jurisdiction and licensed jurisdiction, with licensed states having more control. Such categorization may lead to difference in taxation. Therefore, we are interested in examining if there is any difference in total/state taxation by these two groups of states. 

## Total Tax

First, we looked at the total tax. We performed t-test for each year and would like to see if there is any significant difference in the total tax between control states and licensed states. 

The following plot gives the average tax difference (Tax in the Control States - Tax in the Licensed States), together with its 95% confidence interval and p-value, from 2008 to 2019. 

We can see that the mean difference in the total tax does not deviate much from 0 for all years, though the confidence interval seems to have a fan shape over time. Large p-values from t-tests also suggest that there is **no sufficient evidence showing any significant difference between two jurisdiction groups in the total taxation from 2008 to 2019**.

```{r tax_group}
# tax
year = colnames(tax_df_group)[-c(1:3)]
t_test_output = NULL
for (i in 1:length(year)) {
  t_test = t.test(tax_df_group[[year[i]]]~group, data = tax_df_group) %>% broom::tidy()
  t_test_output = rbind(t_test_output, t_test)
}

tax_group_result = 
  t_test_output %>% 
  mutate(year = year) %>% 
  relocate(year) %>% 
  rename(
    control_est = estimate1, 
    licensed_est = estimate2, 
    control_minus_licensed = estimate) %>% 
  select(year, control_minus_licensed, p.value, conf.low, conf.high) %>% 
  janitor::clean_names() %>% 
  mutate(p_value = round(p_value, 2))

tax_group_result %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = control_minus_licensed)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high)) +
  labs(
    title = "Difference in Total Tax between Control and Licensed Groups over time (p-value)",
    y = "Total Tax Difference (Control - Licensed)", 
    x = "Year") + 
  geom_text(
    aes(label = paste0("(", p_value, ")")), 
    color = "steelblue", hjust = -0.05, vjust = -3.7, angle = 20)
```


## State Tax

Next, we looked at the state tax. As what have been done in previous subsection, we performed t-test for each year and would like to see if there is any significant difference in the state tax between control states and licensed states. 

The following plot gives the average state tax difference (Tax in the Control States - Tax in the Licensed States), together with its 95% confidence interval and p-value, from 2009 to 2019. 

We can see that the mean difference in the state tax does not deviate much from 0 for all years, and the confidence interval seems to be consistently wide over time. Large p-values from t-tests again suggest that there is **no sufficient evidence showing any significant difference between two jurisdiction groups in the state taxation from 2009 to 2019**.

```{r state_tax_group}
# state_tax

state_tax_group_result = 
  state_tax_df_group %>% 
  nest(data = -year) %>% 
  mutate(
    t_test = map(.x = data, ~t.test(adjusted ~ group, data = .x)),
    result = map(t_test, broom::tidy)
  ) %>% 
  select(year, result) %>% 
  unnest(result) %>% 
  rename(control_est = estimate1, 
         licensed_est = estimate2,
         control_minus_licensed = estimate) %>% 
  select(year, control_minus_licensed, p.value, conf.low, conf.high) %>% 
  janitor::clean_names() %>% 
  mutate(p_value = round(p_value, 2))

state_tax_group_result %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = control_minus_licensed)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high)) +
  labs(
    title = "Difference in State Tax between Control and Licensed Groups over time (p-value)",
    y = "State Tax Difference (Control - Licensed)",
    x = "Year") + 
  geom_text(
    aes(label = paste0("(", p_value, ")")), 
    color = "steelblue", hjust = -0.05, vjust = -3.5, angle = 20)
```


## Jurisdiction Map

Here is also a state map showing control jurisdiction and licensed jurisdiction. 

```{r state_map, collapse=T, message=F}
library(maps)
#devtools::install_github("hrbrmstr/hrbrthemes")

us_states <- map_data("state")

states_map = 
  us_states %>% 
  mutate(
    state_group = 
      ifelse(region %in% str_to_lower(license), "licensed", 
             ifelse(region %in% str_to_lower(control), "control", "NA"))
  )

theme_map <- function(base_size=9, base_family="") {
    require(grid)
    theme_bw(base_size=base_size, base_family=base_family) %+replace%
        theme(axis.line=element_blank(),
              axis.text=element_blank(),
              axis.ticks=element_blank(),
              axis.title=element_blank(),
              panel.background=element_blank(),
              panel.border=element_blank(),
              panel.grid=element_blank(),
              panel.spacing=unit(0, "lines"),
              plot.background=element_blank(),
              legend.justification = c(0,0),
              legend.position = c(0,0)
              )
}
p0 <- ggplot(data = states_map,
             mapping = aes(x = long, y = lat,
                           group = group, fill = state_group)) +
  scale_fill_manual(values = c("snow3", "steelblue"))
p1 <- p0 + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(projection = "albers", lat0 = 39, lat1 = 45) 
p2 <- p1 +
    labs(title = "Jurisdiction Group", fill = NULL)
p2 + theme_map() 
```



# Regression Anlaysis

In this part, we would like to explore more regarding the relationship between taxation and jurisdiction group, year, shipments, population, and consumption. 

Results are as follow. Variables with significant p-value are highlighted in blue. 

---

## Full model

First, we consider the full model: 
```
total_tax ~ group + year + shipments + population + consumption
```

Our outcome of interest is total tax, and explaining variables of interest include group, year, shipments, population, and consumption. 

* Licensed states are estimated to have around 6.7k less tax than the control states, controlling year, shipments, population and consumption. Such difference is statistically significant. 
* Also, year 2017, 2018, 2019 are estimated to have about 27k, 36k, and 45k more tax than year 2008, controlling year, shipments, population and consumption. Such difference is statistically significant. 
* Population and shipments have estimated coefficients 0, though they have significant p-values. 
  
```{r reg_df,collapse=T}
# Load state_df
state_df = read_csv("data_import_cleaning/state_df.csv")

# Merge dataset
reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2008":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption) %>% 
  mutate(year = as.character(year))

# Fit model
lm_model = lm(total_tax ~ group + year + shipments + population + consumption, data = reg_df)
summary(lm_model)

#broom::tidy(lm_model) %>% 
#  mutate_at(2:5, round, 2) %>% 
#  janitor::clean_names() %>% 
#  knitr::kable(caption = "Regression result summary") %>% 
#  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
#                            full_width = F) 

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 20)) %>% 
  DT::formatStyle(
    columns = "p_value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```


## Other

We also tried running several sensitivity analyses. 

### Remove shipments

```
total_tax ~ group + year + population + consumption
```
* Licensed states are estimated to have around 6.8k less tax than the control states, controlling year, shipments, population and consumption. Such difference is statistically significant. 
* Also, year 2016, 2017, 2018, 2019 are estimated to have about 21k, 33k, 43k, and 52k more tax than year 2008, controlling year, population and consumption. Such difference is statistically significant. 
* Population has estimated coefficients 0, though it has significant p-value. 

```{r reg_df1,collapse=T}
state_df = read_csv("data_import_cleaning/state_df.csv")

reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2008":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption) %>% 
  mutate(year = as.character(year))

lm_model = lm(total_tax ~ group + year + population + consumption, data = reg_df)
summary(lm_model)

#broom::tidy(lm_model) %>% 
#  mutate_at(2:5, round, 2) %>% 
#  janitor::clean_names() %>% 
#  knitr::kable(caption = "Regression result summary") %>% 
#  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
#                            full_width = F) 

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 20)) %>% 
  DT::formatStyle(
    columns = "p_value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```


### Remove population

```
total_tax ~ group + year + shipments + consumption]
```

* Licensed states are estimated to have around 6.1k less tax than the control states, controlling year, shipments, population and consumption. Such difference is statistically significant. 
* Also, year 2010 is estimated to have about 19k less tax than year 2009, and 2017, 2018, 2019 are estimated to have about 23k, 32k, and 42k more tax than year 2008 controlling year, shipments and consumption. Such differences are statistically significant. 
* Tax is estimated to increase 0.01 with 1 unit increase in shipments. Such increase is statistically significant. 

```{r reg_df2,collapse=T}
state_df = read_csv("data_import_cleaning/state_df.csv")

reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2008":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption) %>% 
  mutate(year = as.character(year))

lm_model = lm(total_tax ~ group + year + shipments + consumption, data = reg_df)
summary(lm_model)

#broom::tidy(lm_model) %>% 
#  mutate_at(2:5, round, 2) %>% 
#  janitor::clean_names() %>% 
#  knitr::kable(caption = "Regression result summary") %>% 
#  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
#                            full_width = F) 

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 20)) %>% 
  DT::formatStyle(
    columns = "p_value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```


### Remove population and shipments

```
total_tax ~ group + year + consumption
```

* There is no jurisdiction group difference in taxation, controlling year, shipments, population and consumption. 
* Also, each year from 2010 to 2014 is estimated to have about 30k more tax than year 2008, and each year from 2015 to 2019 is estimated to have 43k, 57k, 69k, 78k, 87k more tax than year 2008, controlling group and consumption. Such differences are statistically significant. 
* Tax is estimated to decrease 934 with 1 unit increase in consumption. Such decrease is statistically significant. 

```{r reg_df3,collapse=T}
state_df = read_csv("data_import_cleaning/state_df.csv")

reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2008":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption) %>% 
  mutate(year = as.character(year))

lm_model = lm(total_tax ~ group + year + consumption, data = reg_df)
summary(lm_model)

#broom::tidy(lm_model) %>% 
#  mutate_at(2:5, round, 2) %>% 
#  janitor::clean_names() %>% 
#  knitr::kable(caption = "Regression result summary") %>% 
#  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
#                            full_width = F) 

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 20)) %>% 
  DT::formatStyle(
    columns = "p_value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```



### If replacing all 0's with NA in the dataset

```{r reg_df_NA,collapse=T}
# Replace 0 with NA in the reg_df

state_df = read_csv("data_import_cleaning/state_df.csv")

reg_df = 
  tax_df_group %>% 
  pivot_longer(
    "2008":"2019", 
    names_to = "year", 
    values_to = "total_tax"
  ) %>% 
  mutate(year = as.numeric(year)) %>% 
  left_join(., state_df, by = c("state", "year")) %>% 
  select(total_tax, group, year, shipments, population, consumption) %>% 
  mutate(year = as.character(year))

reg_df[reg_df == 0] <- NA

lm_model = lm(total_tax ~ group + year + shipments + population + consumption, data = reg_df)
summary(lm_model)

#broom::tidy(lm_model) %>% 
#  mutate_at(2:5, round, 2) %>% 
#  janitor::clean_names() %>% 
#  knitr::kable(caption = "Regression result summary") %>% 
#  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
#                            full_width = F) 

broom::tidy(lm_model) %>% 
  mutate_at(2:5, round, 2) %>% 
  janitor::clean_names() %>% 
  DT::datatable(., rownames = F, 
                options = list(pageLength = 20)) %>% 
  DT::formatStyle(
    columns = "p_value",
    background = DT::styleInterval(c(0.05),c("lightsteelblue","white")), 
    target = "row")
```

