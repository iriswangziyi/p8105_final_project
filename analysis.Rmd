---
title: "Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

```{r df_tidy, collapse=TRUE,message=FALSE, include=FALSE}
tax_df = read_csv( "data_import_cleaning/tax.csv")
state_tax_df = read_csv("data_import_cleaning/state_tax_df.csv")

# https://abbreviations.yourdictionary.com/articles/state-abbrev.html
state_ref = 
  read.delim("./data_import_cleaning/state_abbreviation.txt", header = F) %>%
  separate(V1, into = c("state", "state_abbrv"), sep = " - ") 

# jurisdiction informatiomn
licence = 
  read_table("./data_import_cleaning/licence_jurisdiction_modified.txt") %>%
  unlist()
control = 
  read_table("./data_import_cleaning/control_jurisdiction_modified.txt") %>%
  unlist()

# tidy tax data: state with abbreviation + group
tax_df_group =  
  left_join(tax_df %>% rename(state_abbrv = state), 
            state_ref, by = "state_abbrv") %>% 
  mutate(
    group = ifelse(state %in% licence, "licenced", 
                   ifelse(state %in% control, "control", "NA"))
  ) %>% 
  relocate(state_abbrv, state, group) %>% 
  slice(-52)

state_tax_df_group = 
  left_join(state_tax_df, state_ref, by = "state") %>% 
  mutate(
    group = ifelse(state %in% licence, "licenced", 
                   ifelse(state %in% control, "control", "NA"))
  ) %>% 
  relocate(state_abbrv, state, group)
```

We focus on two analyses in this section. One is to compare tax differences by jurisdiction group over time. The other is to model taxation under the regression analysis framework. 

---

## Tax differences by jurisdiction group

Differing on the degree of control on liquor wholesales and retail, states can be categorized into two [types](https://www.ncsla.org/State-Officials.html) -- control jurisdiction and licensed jurisdiction, with licensed states having more control. Such categorization may lead to difference in taxation. Therefore, we are interested in examining if there is any difference in total/state taxation by these two groups of states. 

### Total Tax

First, we looked at the total tax. We performed t-test for each year and would like to see if there is any significant difference in the total tax between control states and licensed states. 

The following plot gives the average tax difference (Tax in the Control States - Tax in the Licensed States), together with its 95% confidence interval and p-value, from 2008 to 2019. 

We can see that the mean difference in the total tax does not deviate much from 0 for all years, though the confidence interval seems to have a fan shape over time. Large p-values from t-tests also suggest that there is **no sufficient evidence showing any significant difference between two jurisdiction groups in the total taxation from 2008 to 2019**.

```{r tax_group}
# tax
year = colnames(tax_df_group)[-c(1:3)]
t_test_output = NULL
for (i in 1:length(year)) {
  t_test = t.test(tax_df_group[[year[i]]]~group, data = tax_df_group) %>% broom::tidy()
  t_test_output = rbind(t_test_output, t_test)
}

tax_group_result = 
  t_test_output %>% 
  mutate(year = year) %>% 
  relocate(year) %>% 
  rename(
    control_est = estimate1, 
    licensed_est = estimate2, 
    control_minus_licensed = estimate) %>% 
  select(year, control_minus_licensed, p.value, conf.low, conf.high) %>% 
  janitor::clean_names() %>% 
  mutate(p_value = round(p_value, 2))

tax_group_result %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = control_minus_licensed)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high)) +
  labs(
    title = "Difference in Total Tax between Control and Licensed Groups over time (p-value)",
    y = "Total Tax Difference (Control - Licensed)", 
    x = "Year") + 
  geom_text(
    aes(label = paste0("(", p_value, ")")), 
    color = "#009999", hjust = -0.05, vjust = -3.7, angle = 20)

#ggrepel::geom_text_repel(aes(label = paste0("(", p_value, ")")), vjust = -5)
```


### State Tax

Next, we looked at the state tax. As what have been done in previous subsection, we performed t-test for each year and would like to see if there is any significant difference in the state tax between control states and licensed states. 

The following plot gives the average state tax difference (Tax in the Control States - Tax in the Licensed States), together with its 95% confidence interval and p-value, from 2009 to 2019. 

We can see that the mean difference in the state tax does not deviate much from 0 for all years, and the confidence interval seems to be consistently wide over time. Large p-values from t-tests again suggest that there is **no sufficient evidence showing any significant difference between two jurisdiction groups in the state taxation from 2009 to 2019**.

```{r state_tax_group}
# state_tax

state_tax_group_result = 
  state_tax_df_group %>% 
  nest(data = -year) %>% 
  mutate(
    t_test = map(.x = data, ~t.test(adjusted ~ group, data = .x)),
    result = map(t_test, broom::tidy)
  ) %>% 
  select(year, result) %>% 
  unnest(result) %>% 
  rename(control_est = estimate1, 
         licensed_est = estimate2,
         control_minus_licensed = estimate) %>% 
  select(year, control_minus_licensed, p.value, conf.low, conf.high) %>% 
  janitor::clean_names() %>% 
  mutate(p_value = round(p_value, 2))

state_tax_group_result %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = control_minus_licensed)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high)) +
  labs(
    title = "Difference in State Tax between Control and Licensed Groups over time (p-value)",
    y = "State Tax Difference (Control - Licensed)",
    x = "Year") + 
  geom_text(
    aes(label = paste0("(", p_value, ")")), 
    color = "#009999", hjust = -0.05, vjust = -3.5, angle = 20)
```





