---
title: "Taxation"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(flexdashboard)

tax_df = read_csv( "data_import_cleaning/tax.csv")
state_tax_df = read_csv("data_import_cleaning/state_tax_df.csv")


library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)

library(gifski)
```

---

## Cumulative Taxs Collected 
Looking at just the taxes collected by each state over the years. This tax is specifically looking at the 
"Beer removed for consumption or sale including beer removed tax determined for consumption or sale in a tavern or on brewery premises". This data is coming from the Alcohol and Tobacco Tax and Trade Bureau dataset.

```{r}
tax_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "tax"
  ) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( 
    x = ~year, y = ~tax, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Tax collected over the years by state")
```

Analysis: 

---

## Tax per Barrel
In the [American Beer Distributers](https://www.nbwa.org/sites/default/files/Beer%20Excise%20Tax%202019%20-%20Revised%20July%202020.pdf) dataset specifically about taxation the document reports the Effective Excise Tax (Volume Adjusted), and the Effective Excise Tax with Other and Local Taxes. 

The graphic below shows the Effective Excise Tax (Volume Adjusted). 

```{r}
state_tax_df %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly(
    x = ~year, y = ~adjusted, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Effective Excise Tax (Volume Adjusted) (Tax per Barrel)")
```

Analysis: 

---

## Adjusting for state and local taxes 
This graphic shows the Effective Excise Tax with Other and Local Taxes.

```{r}
state_tax_df %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~and_local_taxes, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Effective Excise Tax with Other and Local Taxes (Tax per Barrel)")
```

Analysis: 

---

## Comparing the Local and State Tax to the Adjusted tax 
Now with these two tax measures it is interesting to see how they differ between state. Below we have took the difference between the local taxes and others with the adjusted. Most of the states have a value of just zero but the graph below just shows the states with a positive difference between the two measurements. 

```{r}
state_tax_df %>%
  select(state, adjusted, state_taxes, and_local_taxes, year) %>%
  mutate(
    diff_state_adj = state_taxes - adjusted,
    diff_local_adj = and_local_taxes - adjusted
  ) %>%
  filter(diff_local_adj > 0) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~diff_local_adj, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Difference between local_taxes and adjusted")
```

Analysis: 


Here is me trying the animation 




```{r}
knitr::opts_chunk$set(
 echo = FALSE,
 fig.width = 7, 
 fig.height = 5,
 fig.asp = 0.6,
 out.width = "70%")
theme_set(theme_bw() + 
          theme(legend.position = "bottom",
                legend.title = element_blank(),
                plot.title = element_text(hjust = 0.5, size = 15),
                plot.subtitle = element_text(hjust = 0.5, size = 12)))



sm3 = state_tax_df %>% filter(state != "District of Columbia")

static_plot<-ggplot(sm3,aes(rank_3,group=state,fill=as.factor(state),color=as.factor(state))) +
 geom_tile(aes(y = adjusted/2,height = adjusted, width = 0.9), alpha = 0.8, color = NA) +
 geom_text(aes(y = 0, label = paste(state, ' ')), vjust = 0.2, hjust = 1) +
 geom_text(aes(y=adjusted,label = paste(' ',adjusted)), hjust=0)+
 coord_flip(clip = 'off', expand = TRUE) +
 scale_y_continuous(labels = scales::comma) +
 scale_x_reverse() +
 guides(color = FALSE, fill = FALSE) +
 theme_minimal() +
 theme(
 plot.title=element_text(size=10, hjust=0.5, face='bold', colour='grey', vjust=-1),
 plot.subtitle=element_text(size=5, hjust=0.5, face='italic', color='grey'),
 plot.caption =element_text(size=5, hjust=0.5, face='italic', color='grey'),
 axis.ticks.y = element_blank(),
 axis.text.y = element_blank(),
 plot.margin = margin(1,1,1,4, 'cm')
 )
plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) +
 ease_aes('cubic-in-out') +
 labs(title = 'Total Tax per Year : {closest_state}',
 x='',y='Total Tax per year')

plt
# final_animation<-animate(plt, 100, fps = 20, duration = 30, 
#                          width = 950, height = 750, 
#                          renderer = gifski_renderer())
# final_animation

```

