---
title: "Consumption"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(flexdashboard)

state_df = read_csv("data_import_cleaning/state_df.csv")
beer = read_csv("./data_import_cleaning/beer.csv")

library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)

library(gifski)

library(usdata)
```

--- 

## Consumption
This graph shows data from the [Shipments of Malt Beverages and Per Capita Consumption by State](https://www.nbwa.org/sites/default/files/2003%20and%202019%20State%20data%20Per%20Capita%20Sheets_1.pdf) document. This consumption is by captiate and only considers individuals who are 21 years old or older. 
```{r warning=FALSE, message=FALSE, fig.width = 7, fig.height = 7}
# state_df %>%
#   filter(year > 2009) %>%
#   mutate(text_label = str_c("state: ", state)) %>% # creating text label 
#   plot_ly( #using plotly to plot he tmax and tmin 
#     x = ~year, y = ~consumption, color = ~factor(state), text = ~text_label,
#     alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
#   layout( # adding a title 
#     title = "Consumption")



sm3 = state_df %>% filter(state != "District of Columbia") %>% filter(year > 2009)

static_plot<-ggplot(sm3,aes(rank_6,group=state,fill=as.factor(state),color=as.factor(state))) +
 geom_tile(aes(y = consumption/2,height = consumption, width = 0.9), alpha = 0.8, color = NA) +
 geom_text(aes(y = 0, label = paste(state, ' ')), vjust = 0.2, hjust = 1, size = 3.5) +
 geom_text(aes(y = consumption, label = paste(' ',consumption)), hjust=0, size = 3.5) +
 coord_flip(clip = 'off', expand = TRUE) +
 scale_y_continuous(labels = scales::comma) +
 scale_x_reverse() +
 guides(color = FALSE, fill = FALSE) +
 theme_minimal() +
 theme(
   plot.title=element_text(size=20, hjust=0.5, face='bold', colour='grey', vjust=-1),
   plot.subtitle=element_text(size=10, hjust=0.5, face='italic', color='grey'),
   plot.caption =element_text(size=1, hjust=0.5, face='italic', color='grey'),
   axis.ticks.y = element_blank(),
   axis.text.y = element_blank(),
   plot.margin = margin(1,1,1,4, 'cm')
 )
plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) +
                   ease_aes('cubic-in-out') +
                   labs(title = 'Consumption in Year {closest_state}',
                        subtitle = 'Per Capita Consumption',
                        x = '', 
                        y = 'Consumption')

plt

```

### Analysis:

---
//intro this map

```{r brewer map, collapse = T, message = F, warning = F}
#install.packages("leaflet")
library(leaflet)

pal <- colorNumeric(
  palette = "viridis",
  domain = beer$alcohol_by_volume)

beer %>% 
  filter(alcohol_by_volume != 0) %>% 
  mutate(
    click_label = 
      str_c("<b>Brewer: ", name,
            "<br>ABV: ", alcohol_by_volume, 
            "</b><br>City: ", city, 
            "<br>State: ", state
            )
  ) %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude,
                   #clusterOptions = markerClusterOptions(),
                   radius = 0.1, 
                   color = ~pal(alcohol_by_volume), 
                   popup = ~click_label)
```


---

## Alcohol by volume (ABV) pattern

**Alcohol by volume (ABV)** is defined to be the volume percent of alcohol (ethanol) contained in a given volume of an alcoholic beverage. 
In our project, we are interested in exploring the pattern of ABV concerning the category/brewer/style of beer. 

### By category

First, we looked at the pattern of ABV by beer's category. 

* It seems that **Belgian and French Ale** has the **highest** average ABV while the **North American Lager** has the **lowest** average AVB. 
* The distribution of ABV of Belgian and French Ale is relatively bell-shaped while the other categories are skewed. 

```{r cat_abv,collapse=TRUE}
cat_abv = 
  beer %>% 
  replace_na(list(category = "NA", y = "unknown")) %>% 
  group_by(category) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv)) 
cat_abv
cat_abv %>% 
  mutate(category = fct_reorder(category, mean_abv)) %>% 
  plot_ly(x = ~category, y = ~mean_abv, 
          color = ~category, type = "bar", colors = "viridis") %>% 
  layout(title = "Average ABV by Beer Category",
         xaxis = list(title = "Beer Category",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(0, 7)))

beer %>% 
  mutate(category = fct_reorder(category, alcohol_by_volume)) %>% 
  plot_ly(y = ~alcohol_by_volume, 
          color = ~category, type = "box", colors = "viridis") %>% 
  layout(title = "Boxplot of ABV by Beer Category",
         xaxis = list(title = "Beer Category",
                      zeroline = TRUE),
         yaxis = list(title = "ABV",
                      range = c(0, 21)))
```


### By brewer

Next, we looked at the pattern of ABV by beer's brewer. 

As there are 823 brewers listed in our dataset, we will show the **top 20** that has the highest average ABV, rather than all of them. 

* **Mendocino Brewing - Ukiah** has the highest average ABV. 
* There are 424 brewers having average ABV value of 0. 

```{r brewer_abv,collapse=TRUE}
brewer_abv = 
  beer %>% 
  group_by(brewer) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv))
brewer_abv

#brewer_abv %>% filter(mean_abv == 0) #424

brewer_abv %>% 
  slice(1:20) %>% 
  mutate(brewer = fct_reorder(brewer, mean_abv)) %>%
  plot_ly(x = ~brewer, y = ~mean_abv, 
          color = ~brewer, type = "bar", colors = "viridis") %>%
  layout(title = "Average ABV by Beer Brewer",
         xaxis = list(title = "Beer Brewer",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(8, 10.8)))

top_20_brewer = brewer_abv %>% slice(1:20) %>% select(brewer) %>% unlist()
beer %>% 
  filter(brewer %in% top_20_brewer) %>% 
  mutate(brewer = fct_reorder(brewer, alcohol_by_volume)) %>% 
  plot_ly(y = ~alcohol_by_volume, 
          color = ~brewer, type = "box", colors = "viridis") %>% 
  layout(title = "Boxplot of ABV by Beer Brewer",
         xaxis = list(title = "ABV",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV"))
```

### By style

Finally, we looked at the pattern of ABV by beer's style. 

There are 62 styles listed in our dataset, and we will show the **top 20** that has the highest average ABV, as well as the **lowest 5**. 

* We can see that **Belgian-Style Quadrupel** has the higherst average ABV while both **Vienna-Style Lager** and **Specialty Honey Lager or Ale** has average ABV of 0. 

```{r style_abv,collapse=TRUE}
style_abv = 
  beer %>% 
  group_by(style) %>% 
  summarise(mean_abv = mean(alcohol_by_volume)) %>% 
  arrange(desc(mean_abv))
style_abv

style_abv %>% 
  slice(1:20) %>% 
  mutate(style = fct_reorder(style, mean_abv)) %>% 
  plot_ly(x = ~style, y = ~mean_abv, 
          color = ~style, type = "bar", colors = "viridis")  %>%
  layout(title = "Average ABV by Beer Style",
         xaxis = list(title = "Beer Style",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV",
                      range = c(5.5, 12)))

tail(style_abv) %>% 
  rename(Style = style, `Average ABV` = mean_abv) %>% 
  slice(-1) %>% 
  mutate_at(2, round, 2) %>% 
  knitr::kable(caption = "Styles with Lowest 5 Average AVB") %>% 
  kableExtra::kable_styling(., bootstrap_options = c("striped", "hover"),
                            full_width = F)

top_20_style = style_abv %>% slice(1:20) %>% select(style) %>% unlist()
beer %>% 
  filter(style %in% top_20_style) %>% 
  mutate(style = fct_reorder(style, alcohol_by_volume)) %>% 
  plot_ly(y = ~alcohol_by_volume, 
          color = ~style, type = "box", colors = "viridis") %>% 
  layout(title = "Boxplot of ABV by Beer Style",
         xaxis = list(title = "ABV",
                      zeroline = TRUE),
         yaxis = list(title = "Average ABV"))
```


