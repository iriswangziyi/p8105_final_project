---
title: "Production"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(flexdashboard)

tax_cans_df    = read_csv("data_import_cleaning/tax_cans.csv")
tax_barrels_df = read_csv("data_import_cleaning/tax_barrels_df.csv")
state_df = read_csv("data_import_cleaning/state_df.csv")

library(ggplot2)
library(broom)
library(plotly)
library(highcharter)
library(rworldmap)
library(gganimate)
library(transformr)
library(corrplot)
library(leaps)
library(kableExtra)

library(gifski)

library(usdata)
```

In this page we are going take an in-depth look at the production of beer across each state in the USA. 

---

## Production of Barrels 
This line graph looks at the amount of Barrels produced by state recorded in barrel units over the years. The data comes from the Alcohol and Tobacco Tax and Trade Bureau dataset. 

```{r warning=FALSE, message=FALSE }
tax_barrels_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "barrels"
  ) %>%
  filter(year > 2009) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~barrels, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Barrel production over the years by state")
```


```{r, warning=FALSE, message=FALSE}
longer_barrel_df = tax_barrels_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "barrels"
  )
longer_barrel_df %>%
  filter(year > 2009) %>%
  group_by(state) %>%
  summarize(
    mean_barrel = mean(barrels),
    CI_lower = mean(barrels) - 1.96 * sd(barrels)/sqrt(length(barrels)),
    CI_upper = mean(barrels) + 1.96 * sd(barrels)/sqrt(length(barrels))
  ) %>%
  mutate(
    state = abbr2state(state),
    state = fct_reorder(state, mean_barrel)) %>% 
  ggplot(aes(x = state, y = mean_barrel, color=state)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(legend.position = "none")  +
  labs(
    title = "Average Barrel Production by State",
    subtitle = "Data from years 2010-2019",
    y = "Barrel Production (in Barrels)",
    x = "State"
  )

```

### Analysis: 

---


## Production Cans and Bottles
This line graph looks at the amount of cans and bottles produced by state recorded in barrel units over the years. The data comes from the Alcohol and Tobacco Tax and Trade Bureau dataset.

```{r}
tax_cans_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "cans_bottles"
  ) %>%
  filter(year > 2009) %>%
  mutate(text_label = str_c("state: ", state)) %>% # creating text label 
  plot_ly( #using plotly to plot he tmax and tmin 
    x = ~year, y = ~cans_bottles, color = ~factor(state), text = ~text_label,
    alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
  layout( # adding a title 
    title = "Can and Bottleproduction over the years by state")
```

```{r, warning=FALSE, message=FALSE}

region = tibble(state = state.abb, state.region)

longer_can_df = tax_cans_df %>%
  filter(state != "total") %>%
  pivot_longer(
    c(`2008`:`2019`),
    names_to = "year",
    values_to = "cans_bottles"
  )
longer_can_df %>%
  filter(year > 2009) %>%
  group_by(state) %>%
  summarize(
    mean_barrel = mean(cans_bottles),
    CI_lower = mean(cans_bottles) - 1.96 * sd(cans_bottles)/sqrt(length(cans_bottles)),
    CI_upper = mean(cans_bottles) + 1.96 * sd(cans_bottles)/sqrt(length(cans_bottles))
  ) %>%
  mutate(
    state = abbr2state(state),
    state = fct_reorder(state, mean_barrel)) %>% 
  ggplot(aes(x = state, y = mean_barrel, color=state)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(legend.position = "none")  +
  labs(
    title = "Average Can and Bottle Production by State",
    subtitle = "Data from years 2010-2019",
    y = "Can and Bottle Production (in Barrels)",
    x = "State"
  )

```

### Analysis: 

--- 

## Shipments of Malt Beverages
This is the amount of shipments the United States has made of malt beverages in barrel units. This data comes from the American Beer Distributors. 

```{r}
# state_df %>%
#   filter(year > 2009) %>%
#   mutate(text_label = str_c("state: ", state)) %>% # creating text label 
#   plot_ly( #using plotly to plot he tmax and tmin 
#     x = ~year, y = ~shipments, color = ~factor(state), text = ~text_label,
#     alpha = .5, type = "scatter", mode = "lines", colors = "viridis") %>%
#   layout( # adding a title 
#     title = "Shipments")
```

```{r fig.width = 7, fig.height = 7}

sm3 = state_df %>% filter(state != "District of Columbia") %>% filter(year > 2009)

static_plot<-ggplot(sm3,aes(rank_3,group=state,fill=as.factor(state),color=as.factor(state))) +
 geom_tile(aes(y = shipments/2,height = shipments, width = 0.9), alpha = 0.8, color = NA) +
 geom_text(aes(y = 0, label = paste(state, ' ')), vjust = 0.2, hjust = 1, size = 3.5) +
 geom_text(aes(y = shipments, label = paste(' ',shipments)), hjust=0, size = 3.5) +
 coord_flip(clip = 'off', expand = TRUE) +
 scale_y_continuous(labels = scales::comma) +
 scale_x_reverse() +
 guides(color = FALSE, fill = FALSE) +
 theme_minimal() +
 theme(
   plot.title=element_text(size=20, hjust=0.5, face='bold', colour='grey', vjust=-1),
   plot.subtitle=element_text(size=10, hjust=0.5, face='italic', color='grey'),
   plot.caption =element_text(size=1, hjust=0.5, face='italic', color='grey'),
   axis.ticks.y = element_blank(),
   axis.text.y = element_blank(),
   plot.margin = margin(1,1,1,4, 'cm')
 )
plt<-static_plot + transition_states(states = year, transition_length = 4, state_length = 1) +
                   ease_aes('cubic-in-out') +
                   labs(title = 'Shipments in Year {closest_state}',
                        #subtitle = 'Shipments',
                        x = '', 
                        y = 'Shipments of Malt Beverages')

plt

```

### Analysis: 
